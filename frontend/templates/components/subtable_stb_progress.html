{% set t_range = range(1, 32) %}
<div class="overflow-auto">
  <div class="mb-2">
    <button
      onclick="captureTable('replacement_progress')"
      class="text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded"
    >
      Capture
    </button>
  </div>
  <table
    id="replacement_progress"
    class="min-w-full text-sm border border-black text-center align-middle whitespace-nowrap"
  >
    <thead class="text-xs">
      <tr>
        <th colspan="42" class="bg-yellow-300 font-bold border border-black py-2 text-lg">
          PROGRESS HARIAN REPLACEMENT STB (170K)
        </th>
      </tr>
      <tr>
        <th class="bg-red-300 border border-black px-2 py-1 w-[150px]">TOTAL TEKNISI</th>
        <th colspan="2" class="bg-yellow-200 border border-black px-2 py-1 w-[180px]">REPLACEMENT STB</th>
        <th class="bg-blue-200 text-black border border-black px-2 py-1 w-[70px]">SALDO</th>
        <th colspan="35" class="bg-cyan-200 border border-black px-1 py-1">PROGRES</th>
      </tr>
      <tr>
        <th class="bg-white border border-black px-2 py-1">JUMLAH</th>
        <th class="bg-green-200 border border-black px-2 py-1">SERVICE AREA</th>
        <th class="bg-green-300 border border-black px-2 py-1">STO</th>
        <th class="bg-blue-200 border border-black px-2 py-1">AWAL</th>
        <th class="bg-yellow-200 border border-black px-2 py-1">ASSIGN</th>
        {% for i in t_range %}
        <th class="bg-red-600 text-white border border-black px-2 py-1 w-[36px]">{{ i }}</th>
        {% endfor %}
        <th class="bg-green-200 border border-black px-2 py-1">Berhasil</th>
        <th class="bg-orange-300 border border-black px-2 py-1">Kendala</th>
        <th class="bg-orange-500 border border-black px-2 py-1">Sisa Saldo</th>
      </tr>
    </thead>

    <tbody class="text-sm">
      {% if stb_progress %}
        {% for row in stb_progress %}
          {% if not row.is_total_row and row.service_area not in ['COLLECT', 'KENDALA', 'TOTAL VISIT HI'] %}
          <tr>
            <td class="border border-black px-2 py-1">{{ row.teknisi }}</td>
            <td class="border border-black px-2 py-1">{{ row.service_area }}</td>
            <td class="border border-black px-2 py-1">{{ row.sto }}</td>
            <td class="border border-black px-2 py-1">{{ row.saldo_awal }}</td>
            <td class="border border-black px-2 py-1">{{ row.assign }}</td>
            {% for i in t_range %}
            {% set val = getattr(row, 't' ~ i, 0) or 0 %}
            <td class="border border-black px-1 py-1 {% if val > 0 %}bg-green-300{% endif %}">{{ val }}</td>
            {% endfor %}
            <td class="border border-black px-2 py-1">{{ row.berhasil }}</td>
            <td class="border border-black px-2 py-1">{{ row.kendala }}</td>
            <td class="border border-black px-2 py-1">{{ row.saldo_akhir }}</td>
          </tr>
          {% endif %}
        {% endfor %}
      {% endif %}

      {% set total_collect = stb_progress | selectattr("service_area", "equalto", "COLLECT") | list | first %}
      {% set total_kendala = stb_progress | selectattr("service_area", "equalto", "KENDALA") | list | first %}
      {% set total_visit_hi = stb_progress | selectattr("service_area", "equalto", "TOTAL VISIT HI") | list | first %}
      {% set total = stb_progress | selectattr("service_area", "equalto", "TOTAL") | list | first %}

      <tr class="font-bold">
        <td class="border border-black bg-cyan-300 align-middle" rowspan="3">
          {{ total.teknisi if total else 0 }}
        </td>
        <td class="border border-black bg-green-100 align-middle" rowspan="3" colspan="2">TOTAL</td>
        <td class="border border-black bg-blue-400 text-black align-middle" rowspan="3">
          {{ total.saldo_awal if total else 0 }}
        </td>

        <td class="border border-black bg-green-500 text-black p-2">COLLECT</td>
        {% for i in t_range %}
          {% set val = stb_progress
            | rejectattr("is_total_row")
            | rejectattr("service_area", "in", ["COLLECT", "KENDALA", "TOTAL VISIT HI"])
            | map(attribute="t" ~ i)
            | select
            | sum %}
          <td class="border border-black bg-green-300 text-black">{{ val }}</td>
        {% endfor %}
        <td class="border border-black bg-green-500 text-black">
          {{ total_collect.berhasil if total_collect else 0 }}
        </td>
        <td class="border border-black bg-black"></td>
        <td rowspan="3" class="border border-black bg-orange-400 text-black">
          {{ total.saldo_akhir if total else 0 }}
        </td>
      </tr>

      <tr class="font-bold">
        <td class="border border-black bg-red-300 text-black p-2">KENDALA</td>
        {% for i in t_range %}
        {% set val = getattr(total_kendala, 't' ~ i, 0) if total_kendala else 0 %}
        <td class="border border-black bg-red-200">{{ val }}</td>
        {% endfor %}
        <td class="border border-black bg-black"></td>
        <td class="border border-black bg-red-300 text-black">
          {{ total_kendala.kendala if total_kendala else 0 }}
        </td>
      </tr>

      <tr class="font-bold">
        <td class="border border-black bg-yellow-400 text-black p-2">TOTAL VISIT HI</td>
        {% for i in t_range %}
        {% set val1 = getattr(total_collect, 't' ~ i, 0) if total_collect else 0 %}
        {% set val2 = getattr(total_kendala, 't' ~ i, 0) if total_kendala else 0 %}
        <td class="border border-black bg-yellow-200">
          {{ val1 + val2 }}
        </td>
        {% endfor %}
        <td colspan="2" class="border border-black bg-yellow-400 text-center text-black">
          {{
            (total_collect.berhasil if total_collect else 0) +
            (total_kendala.kendala if total_kendala else 0)
          }}
        </td>
      </tr>
    </tbody>
  </table>
</div>
